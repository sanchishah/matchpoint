generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Auth ───────────────────────────────────────────

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  passwordHash  String?
  emailVerified DateTime?
  image         String?
  role               UserRole   @default(USER)
  status             UserStatus @default(ACTIVE)
  welcomeEmailSentAt DateTime?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  profile           Profile?
  accounts          Account[]
  sessions          Session[]
  slotParticipants  SlotParticipant[]
  gameParticipants  GameParticipant[]
  payments          Payment[]
  messagesSent      Message[]
  ratingsGiven      Rating[]        @relation("RaterRatings")
  ratingsReceived   Rating[]        @relation("RateeRatings")
  attendances       Attendance[]    @relation("UserAttendance")
  attendancesMarked Attendance[]    @relation("MarkerAttendance")
  strikes           Strike[]
  notifications     Notification[]
  favoriteClubs     FavoriteClub[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ─── Profile ────────────────────────────────────────

model Profile {
  id          String      @id @default(cuid())
  userId      String      @unique
  name        String
  age         Int
  ageBracket  AgeBracket
  gender      Gender
  skillLevel  Int         // 1-5
  radiusMiles Int         // 3, 5, or 10
  zip         String
  lat         Float?
  lng         Float?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ─── Clubs & Courts ─────────────────────────────────

model Club {
  id        String   @id @default(cuid())
  name      String
  address   String
  city      String
  state     String   @default("CA")
  zip       String
  lat       Float
  lng       Float
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  slots         Slot[]
  favoriteClubs FavoriteClub[]
}

model FavoriteClub {
  id        String   @id @default(cuid())
  userId    String
  clubId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  club Club @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@unique([userId, clubId])
}

// ─── Slots (Inventory) ─────────────────────────────

model Slot {
  id              String     @id @default(cuid())
  clubId          String
  startTime       DateTime
  durationMins    Int        // 60 or 120
  format          GameFormat
  requiredPlayers Int        // 2 for singles, 4 for doubles
  totalCostCents  Int        // e.g. 500 = $5.00, 1000 = $10.00
  skillLevel      Int        // 1-5, for matching
  ageBracket      AgeBracket // for matching
  status          SlotStatus @default(OPEN)
  lockTime        DateTime   // startTime - 8 hours
  notes           String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  club         Club              @relation(fields: [clubId], references: [id], onDelete: Cascade)
  participants SlotParticipant[]
  game         Game?
}

model SlotParticipant {
  id       String                @id @default(cuid())
  slotId   String
  userId   String
  status   SlotParticipantStatus @default(JOINED)
  joinedAt DateTime              @default(now())

  slot Slot @relation(fields: [slotId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([slotId, userId])
}

// ─── Games ──────────────────────────────────────────

model Game {
  id        String     @id @default(cuid())
  slotId    String     @unique
  clubId    String
  startTime DateTime
  endTime   DateTime
  status    GameStatus @default(CONFIRMED)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  slot         Slot              @relation(fields: [slotId], references: [id], onDelete: Cascade)
  participants GameParticipant[]
  payments     Payment[]
  messages     Message[]
  ratings      Rating[]
  attendances  Attendance[]
}

model GameParticipant {
  id     String @id @default(cuid())
  gameId String
  userId String

  game Game @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([gameId, userId])
}

// ─── Payments ───────────────────────────────────────

model Payment {
  id                    String        @id @default(cuid())
  gameId                String
  userId                String
  amountCents           Int
  stripePaymentIntentId String?
  status                PaymentStatus @default(PENDING)
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  game Game @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([gameId, userId])
}

// ─── Stripe Webhook Events ──────────────────────────

model StripeWebhookEvent {
  id          String   @id @default(cuid())
  provider    String   @default("stripe")
  eventId     String   @unique
  processedAt DateTime
  createdAt   DateTime @default(now())
  payloadHash String?
}

// ─── Messages (Game Chat) ───────────────────────────

model Message {
  id        String   @id @default(cuid())
  gameId    String
  userId    String
  body      String
  createdAt DateTime @default(now())

  game Game @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ─── Ratings ────────────────────────────────────────

model Rating {
  id        String    @id @default(cuid())
  gameId    String
  raterId   String
  rateeId   String
  stars     Int       // 1-5
  feltLevel FeltLevel
  comment   String?
  createdAt DateTime  @default(now())

  game  Game @relation(fields: [gameId], references: [id], onDelete: Cascade)
  rater User @relation("RaterRatings", fields: [raterId], references: [id], onDelete: Cascade)
  ratee User @relation("RateeRatings", fields: [rateeId], references: [id], onDelete: Cascade)

  @@unique([gameId, raterId, rateeId])
}

// ─── Attendance & Strikes ───────────────────────────

model Attendance {
  id           String  @id @default(cuid())
  gameId       String
  userId       String
  present      Boolean
  markedByUserId String
  createdAt    DateTime @default(now())

  game     Game @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user     User @relation("UserAttendance", fields: [userId], references: [id], onDelete: Cascade)
  markedBy User @relation("MarkerAttendance", fields: [markedByUserId], references: [id], onDelete: Cascade)

  @@unique([gameId, userId])
}

model Strike {
  id        String   @id @default(cuid())
  userId    String
  gameId    String?
  reason    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ─── Notifications ──────────────────────────────────

model Notification {
  id        String    @id @default(cuid())
  userId    String
  type      String
  title     String
  body      String
  readAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ─── Contact Messages ───────────────────────────────

model ContactMessage {
  id        String   @id @default(cuid())
  name      String
  email     String
  message   String
  createdAt DateTime @default(now())
}

// ─── Enums ──────────────────────────────────────────

enum UserRole {
  USER
  ADMIN
}

enum UserStatus {
  ACTIVE
  RESTRICTED
}

enum AgeBracket {
  AGE_18_24
  AGE_25_34
  AGE_35_44
  AGE_45_54
  AGE_55_64
  AGE_65_PLUS
}

enum Gender {
  MALE
  FEMALE
  NON_BINARY
  PREFER_NOT_TO_SAY
  OTHER
}

enum GameFormat {
  SINGLES
  DOUBLES
}

enum SlotStatus {
  OPEN
  PENDING_FILL
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum SlotParticipantStatus {
  JOINED
  WAITLISTED
  CANCELLED
  PAYMENT_FAILED
}

enum GameStatus {
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
}

enum FeltLevel {
  BELOW
  AT
  ABOVE
}
